<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Photo Moments - Snap & Share</title>
    <!-- Tailwind CSS (CDN経由) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons (CDN経由) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --app-height: 100dvh;
        }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            height: var(--app-height);
            margin: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .hidden { display: none !important; }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #app {
            width: 100%;
            max-width: 512px;
            height: var(--app-height);
            display: flex;
            flex-direction: column;
            background-color: white;
            position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.1);
        }

        #main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* 固定ボタンバー */
        .fixed-action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid #e2e8f0;
            padding: 1.25rem;
            padding-bottom: calc(1.25rem + env(safe-area-inset-bottom));
            z-index: 100;
            box-shadow: 0 -10px 20px -5px rgba(0, 0, 0, 0.08);
        }

        .toolbar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 9999px;
            transition: all 0.2s;
            color: #64748b;
        }
        .toolbar-btn:hover { background-color: #f1f5f9; color: #1e293b; }
        .toolbar-btn:disabled { opacity: 0.2; cursor: not-allowed; }

        .preview-image-box {
            max-height: 42dvh;
            width: 100%;
            background-color: #f8fafc;
            border-radius: 1.25rem;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        #txt-comment {
            text-align: center;
        }

        textarea::placeholder { color: #cbd5e1; }
        #main-content::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="app">
        <!-- 固定ヘッダー -->
        <header class="p-4 flex items-center justify-between border-b bg-white z-[110] flex-shrink-0 shadow-sm">
            <div class="flex items-center gap-2">
                <button id="btn-global-back" class="p-2 hover:bg-slate-100 rounded-full transition-colors hidden">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-slate-600"></i>
                </button>
                <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-600 to-violet-600 bg-clip-text text-transparent">
                    Photo Moments
                </h1>
            </div>
            <div class="flex items-center gap-1">
                <button id="btn-reset" class="text-sm font-bold text-slate-400 hover:text-indigo-600 hidden px-2">新規作成</button>
            </div>
        </header>

        <!-- メインコンテンツ領域 -->
        <main id="main-content" class="relative">
            
            <!-- ステージ: 選択 -->
            <section id="stage-select" class="p-8 flex flex-col items-center justify-center min-h-full gap-8 fade-in">
                <div class="text-center space-y-2">
                    <p class="text-slate-500 text-sm font-medium">思い出の瞬間に、タイムスタンプを添えて。</p>
                </div>
                
                <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">
                <input type="file" id="file-input" accept="image/*" class="hidden">

                <button id="btn-camera" class="w-full p-8 rounded-3xl bg-indigo-50 border-2 border-indigo-100 hover:border-indigo-300 transition-all flex flex-col items-center gap-4 group">
                    <div class="p-4 bg-indigo-600 rounded-2xl text-white shadow-lg group-active:scale-90 transition-transform">
                        <i data-lucide="camera" class="w-12 h-12"></i>
                    </div>
                    <span class="text-lg font-bold text-indigo-900">カメラで撮影</span>
                </button>

                <button id="btn-file" class="w-full p-8 rounded-3xl bg-slate-50 border-2 border-slate-100 hover:border-slate-300 transition-all flex flex-col items-center gap-4 group">
                    <div class="p-4 bg-slate-600 rounded-2xl text-white shadow-lg group-active:scale-90 transition-transform">
                        <i data-lucide="image" class="w-12 h-12"></i>
                    </div>
                    <span class="text-lg font-bold text-slate-900">画像を選択</span>
                </button>
                
                <footer class="mt-8 text-center pb-8">
                    <p class="text-[10px] text-slate-300 font-medium tracking-widest uppercase">Created with Photo Moments</p>
                </footer>
            </section>

            <!-- ステージ: 編集 -->
            <section id="stage-edit" class="hidden flex flex-col p-6 space-y-6 fade-in pb-48">
                <div class="preview-image-box flex items-center justify-center">
                    <img id="img-edit-preview" src="" alt="preview" class="w-full h-full object-contain">
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1">
                            <label class="text-sm font-bold text-slate-700">コメント</label>
                            <button id="btn-undo" class="toolbar-btn" title="戻る"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
                            <button id="btn-redo" class="toolbar-btn" title="進む"><i data-lucide="redo-2" class="w-5 h-5"></i></button>
                            <button id="btn-delete" class="toolbar-btn text-red-400" title="クリア"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 border-2 border-slate-200 rounded-2xl p-4 focus-within:border-indigo-400 focus-within:bg-white transition-all shadow-inner">
                        <textarea id="txt-comment" placeholder="思い出の内容を入力..." class="w-full h-32 bg-transparent border-none focus:ring-0 outline-none resize-none text-slate-800 text-lg"></textarea>
                    </div>
                    <p class="text-[10px] text-slate-400 font-medium text-center">※タイムスタンプは自動挿入されています。</p>
                </div>
            </section>

            <!-- ステージ: プレビュー -->
            <section id="stage-preview" class="hidden flex flex-col p-6 space-y-8 fade-in pb-56">
                <div class="rounded-3xl overflow-hidden shadow-2xl border border-slate-200 bg-white">
                    <img id="img-final-result" src="" alt="Final Result" class="w-full h-auto">
                </div>
                <div class="h-4"></div>
            </section>

        </main>

        <!-- 編集画面用アクションバー -->
        <div id="bar-edit" class="fixed-action-bar hidden">
            <button id="btn-generate-preview" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-200 active:scale-95 transition-all">
                <i data-lucide="check" class="w-6 h-6"></i>
                プレビュー作成
            </button>
        </div>

        <!-- プレビュー画面用アクションバー -->
        <div id="bar-preview" class="fixed-action-bar hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <button id="btn-copy" class="flex items-center justify-center gap-2 py-4 bg-slate-100 text-slate-800 rounded-2xl font-bold active:scale-95 transition-all">
                    <i data-lucide="copy" class="w-5 h-5"></i>
                    コピー
                </button>
                <button id="btn-share" class="flex items-center justify-center gap-2 py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all">
                    <i data-lucide="share-2" class="w-5 h-5"></i>
                    保存・共有
                </button>
            </div>
            <button id="btn-back-to-edit" class="w-full flex items-center justify-center gap-2 py-2 text-slate-400 font-medium active:text-slate-800 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                編集に戻る
            </button>
        </div>

        <canvas id="hidden-canvas" class="hidden"></canvas>
    </div>

    <script type="module">
        const state = {
            stage: 'SELECT',
            imageSrc: null,
            processedImageSrc: null,
            timestamp: '',
            history: [],
            historyIndex: -1
        };

        const dom = {
            stages: {
                SELECT: document.getElementById('stage-select'),
                EDIT: document.getElementById('stage-edit'),
                PREVIEW: document.getElementById('stage-preview')
            },
            bars: {
                EDIT: document.getElementById('bar-edit'),
                PREVIEW: document.getElementById('bar-preview')
            },
            btnGlobalBack: document.getElementById('btn-global-back'),
            btnReset: document.getElementById('btn-reset'),
            cameraInput: document.getElementById('camera-input'),
            fileInput: document.getElementById('file-input'),
            btnCamera: document.getElementById('btn-camera'),
            btnFile: document.getElementById('btn-file'),
            imgEditPreview: document.getElementById('img-edit-preview'),
            txtComment: document.getElementById('txt-comment'),
            btnUndo: document.getElementById('btn-undo'),
            btnRedo: document.getElementById('btn-redo'),
            btnDelete: document.getElementById('btn-delete'),
            btnGeneratePreview: document.getElementById('btn-generate-preview'),
            imgFinalResult: document.getElementById('img-final-result'),
            btnCopy: document.getElementById('btn-copy'),
            btnShare: document.getElementById('btn-share'),
            btnBackToEdit: document.getElementById('btn-back-to-edit'),
            canvas: document.getElementById('hidden-canvas'),
            mainContent: document.getElementById('main-content')
        };

        function pushToHistory() {
            const currentVal = dom.txtComment.value;
            if (state.historyIndex >= 0 && state.history[state.historyIndex] === currentVal) return;
            state.history = state.history.slice(0, state.historyIndex + 1);
            state.history.push(currentVal);
            state.historyIndex = state.history.length - 1;
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            dom.btnUndo.disabled = state.historyIndex <= 0;
            dom.btnRedo.disabled = state.historyIndex >= state.history.length - 1;
        }

        function updateUI() {
            Object.keys(dom.stages).forEach(key => dom.stages[key].classList.toggle('hidden', key !== state.stage));
            dom.bars.EDIT.classList.toggle('hidden', state.stage !== 'EDIT');
            dom.bars.PREVIEW.classList.toggle('hidden', state.stage !== 'PREVIEW');
            dom.btnGlobalBack.classList.toggle('hidden', state.stage === 'SELECT');
            dom.btnReset.classList.toggle('hidden', state.stage !== 'PREVIEW');

            if (state.stage === 'EDIT') {
                dom.imgEditPreview.src = state.imageSrc;
                dom.mainContent.scrollTo(0,0);
            }
            if (state.stage === 'PREVIEW') {
                dom.imgFinalResult.src = state.processedImageSrc;
                dom.mainContent.scrollTo(0,0);
            }
            lucide.createIcons();
            updateHistoryButtons();
        }

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                state.imageSrc = e.target.result;
                state.timestamp = new Date().toLocaleString('ja-JP');
                dom.txtComment.value = `${state.timestamp}\n`;
                state.history = [];
                state.historyIndex = -1;
                pushToHistory();
                state.stage = 'EDIT';
                updateUI();
            };
            reader.readAsDataURL(file);
        }

        async function generateCard() {
            const ctx = dom.canvas.getContext('2d');
            const img = new Image();
            img.src = state.imageSrc;
            await new Promise(res => img.onload = res);
            
            const canvasWidth = 1080;
            const imgH = (img.height / img.width) * canvasWidth;
            const comment = dom.txtComment.value.trim();
            
            if (!comment) {
                dom.canvas.width = canvasWidth;
                dom.canvas.height = imgH;
                ctx.drawImage(img, 0, 0, canvasWidth, imgH);
            } else {
                const lines = dom.txtComment.value.split('\n');
                const footerHeight = 100 + (lines.length * 70) + 60;
                dom.canvas.width = canvasWidth;
                dom.canvas.height = imgH + footerHeight;
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, dom.canvas.width, dom.canvas.height);
                ctx.drawImage(img, 0, 0, canvasWidth, imgH);
                
                ctx.fillStyle = '#1e293b';
                ctx.font = 'bold 44px "Noto Sans JP", sans-serif';
                ctx.textAlign = 'center'; // 中央揃えに設定
                
                let y = imgH + 100;
                lines.forEach(l => {
                    ctx.fillText(l, canvasWidth / 2, y); // X座標を中央（540）に
                    y += 70;
                });
            }
            state.processedImageSrc = dom.canvas.toDataURL('image/png');
            state.stage = 'PREVIEW';
            updateUI();
        }

        // イベント設定
        dom.btnCamera.onclick = () => dom.cameraInput.click();
        dom.btnFile.onclick = () => dom.fileInput.click();
        dom.cameraInput.onchange = (e) => handleFile(e.target.files[0]);
        dom.fileInput.onchange = (e) => handleFile(e.target.files[0]);
        dom.btnGeneratePreview.onclick = generateCard;
        dom.btnGlobalBack.onclick = () => { state.stage = 'SELECT'; updateUI(); };
        dom.btnBackToEdit.onclick = () => { state.stage = 'EDIT'; updateUI(); };
        dom.btnReset.onclick = () => { state.stage = 'SELECT'; updateUI(); };
        dom.btnCopy.onclick = async () => {
            try {
                const blob = await (await fetch(state.processedImageSrc)).blob();
                await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
                alert("クリップボードにコピーしました");
            } catch (e) { alert("コピーに失敗しました"); }
        };
        dom.btnShare.onclick = async () => {
            try {
                const blob = await (await fetch(state.processedImageSrc)).blob();
                const file = new File([blob], `photo-${Date.now()}.png`, { type: 'image/png' });
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: 'Photo Moments' });
                } else {
                    const a = document.createElement('a');
                    a.href = state.processedImageSrc;
                    a.download = file.name;
                    a.click();
                }
            } catch (e) { alert("保存・共有に失敗しました"); }
        };
        dom.btnUndo.onclick = () => {
            if(state.historyIndex > 0) {
                state.historyIndex--;
                dom.txtComment.value = state.history[state.historyIndex];
                updateHistoryButtons();
            }
        };
        dom.btnRedo.onclick = () => {
            if(state.historyIndex < state.history.length - 1) {
                state.historyIndex++;
                dom.txtComment.value = state.history[state.historyIndex];
                updateHistoryButtons();
            }
        };
        dom.btnDelete.onclick = () => { dom.txtComment.value = ""; pushToHistory(); };
        let t;
        dom.txtComment.oninput = () => {
            clearTimeout(t);
            t = setTimeout(pushToHistory, 500);
        };

        updateUI();
    </script>
</body>
</html>
