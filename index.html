<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Photo Moments - Snap & Share</title>
    <!-- Tailwind CSS (CDN経由) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons (CDN経由) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --app-height: 100dvh;
        }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            height: var(--app-height);
            margin: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-font-smoothing: antialiased;
        }
        .hidden { display: none !important; }
        
        /* GPU加速アニメーション */
        .fade-in {
            animation: fadeIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: opacity, transform;
            transform: translateZ(0);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px) translateZ(0); }
            to { opacity: 1; transform: translateY(0) translateZ(0); }
        }
        
        #app {
            width: 100%;
            max-width: 512px;
            height: var(--app-height);
            display: flex;
            flex-direction: column;
            background-color: white;
            position: relative;
            box-shadow: 0 10px 50px rgba(0,0,0,0.1);
            overflow: hidden;
            isolation: isolate;
            perspective: 1000px; /* 3Dアクセラレーションの安定化 */
        }

        /* スクロール領域の徹底チューニング */
        #main-content {
            flex: 1;
            overflow-y: auto; 
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            scroll-behavior: auto; 
            will-change: transform;
            transform: translateZ(0);
            background-color: #ffffff;
            contain: content; 
        }

        header, .fixed-action-bar {
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        .fixed-action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-top: 1px solid #f1f5f9;
            padding: 1.25rem;
            padding-bottom: calc(1.25rem + env(safe-area-inset-bottom));
            z-index: 100;
            box-shadow: 0 -10px 30px -10px rgba(0, 0, 0, 0.05);
        }

        .toolbar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 9999px;
            transition: all 0.2s;
            color: #64748b;
        }
        .toolbar-btn:hover { background-color: #f1f5f9; color: #1e293b; }
        .toolbar-btn:disabled { opacity: 0.15; cursor: not-allowed; }

        .preview-image-box {
            max-height: 40dvh;
            width: 100%;
            background-color: #f8fafc;
            border-radius: 1.5rem;
            overflow: hidden;
            border: 1px solid #f1f5f9;
            transform: translateZ(0);
        }

        #txt-comment {
            text-align: center;
        }

        textarea::placeholder { color: #cbd5e1; }
        #main-content::-webkit-scrollbar { display: none; }
        
        #img-final-result {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: high-quality;
        }
    </style>
</head>
<body>

    <div id="app">
        <!-- 固定ヘッダー -->
        <header class="p-4 flex items-center justify-between border-b bg-white/95 backdrop-blur-md z-[110] flex-shrink-0 shadow-sm">
            <div class="flex items-center gap-2">
                <button id="btn-global-back" class="p-2 hover:bg-slate-100 rounded-full transition-colors hidden">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-slate-600"></i>
                </button>
                <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-600 to-violet-600 bg-clip-text text-transparent">
                    Photo Moments
                </h1>
            </div>
            <div class="flex items-center gap-1">
                <button id="btn-reset" class="text-sm font-bold text-slate-400 hover:text-indigo-600 hidden px-2">新規作成</button>
            </div>
        </header>

        <!-- メインコンテンツ領域 -->
        <main id="main-content" class="relative">
            
            <!-- ステージ: 選択 -->
            <section id="stage-select" class="p-8 flex flex-col items-center justify-center min-h-full gap-8 fade-in">
                <div class="text-center space-y-2">
                    <p class="text-slate-500 text-sm font-medium">思い出の瞬間に、タイムスタンプを添えて。</p>
                </div>
                
                <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">
                <input type="file" id="file-input" accept="image/*" class="hidden">

                <button id="btn-camera" class="w-full p-8 rounded-3xl bg-indigo-50 border-2 border-indigo-100 hover:border-indigo-300 transition-all flex flex-col items-center gap-4 group">
                    <div class="p-5 bg-indigo-600 rounded-2xl text-white shadow-xl group-active:scale-95 transition-transform">
                        <i data-lucide="camera" class="w-12 h-12"></i>
                    </div>
                    <span class="text-lg font-bold text-indigo-900">カメラで撮影</span>
                </button>

                <button id="btn-file" class="w-full p-8 rounded-3xl bg-slate-50 border-2 border-slate-100 hover:border-slate-300 transition-all flex flex-col items-center gap-4 group">
                    <div class="p-5 bg-slate-600 rounded-2xl text-white shadow-xl group-active:scale-95 transition-transform">
                        <i data-lucide="image" class="w-12 h-12"></i>
                    </div>
                    <span class="text-lg font-bold text-slate-900">画像を選択</span>
                </button>
                
                <footer class="mt-8 text-center pb-8 opacity-40">
                    <p class="text-[10px] text-slate-400 font-medium tracking-widest uppercase">Created with Photo Moments</p>
                </footer>
            </section>

            <!-- ステージ: 編集 -->
            <section id="stage-edit" class="hidden flex flex-col p-6 space-y-6 fade-in pb-48">
                <div class="preview-image-box flex items-center justify-center shadow-md">
                    <img id="img-edit-preview" src="" alt="preview" class="w-full h-full object-contain">
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1">
                            <label class="text-sm font-bold text-slate-700">コメント</label>
                            <button id="btn-undo" class="toolbar-btn" title="戻る"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
                            <button id="btn-redo" class="toolbar-btn" title="進む"><i data-lucide="redo-2" class="w-5 h-5"></i></button>
                            <button id="btn-delete" class="toolbar-btn text-red-400" title="クリア"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 border-2 border-slate-200 rounded-2xl p-4 focus-within:border-indigo-400 focus-within:bg-white transition-all shadow-inner">
                        <textarea id="txt-comment" placeholder="思い出の内容を入力..." class="w-full h-32 bg-transparent border-none focus:ring-0 outline-none resize-none text-slate-800 text-lg"></textarea>
                    </div>
                    <p class="text-[10px] text-slate-400 font-medium text-center">※タイムスタンプは自動挿入されています。</p>
                </div>
            </section>

            <!-- ステージ: プレビュー -->
            <section id="stage-preview" class="hidden flex flex-col p-6 space-y-8 fade-in pb-64">
                <div class="relative">
                    <div class="rounded-3xl overflow-hidden shadow-2xl border border-slate-100 bg-white">
                        <img id="img-final-result" src="" alt="Final Result" class="w-full h-auto">
                    </div>
                    <div class="mt-6 flex flex-col items-center gap-2">
                        <span id="info-file-size" class="px-5 py-2 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full border border-indigo-100 flex items-center gap-2 shadow-sm">
                            <span class="px-1.5 py-0.5 bg-indigo-600 text-white rounded text-[10px]">JPEG</span>
                            約 -- MB (高画質)
                        </span>
                        <p id="info-png-estimate" class="text-[10px] text-slate-400 font-medium">
                            ※PNG形式の場合、約 -- MB になります
                        </p>
                    </div>
                </div>
            </section>

        </main>

        <!-- アクションバー -->
        <div id="bar-edit" class="fixed-action-bar hidden">
            <button id="btn-generate-preview" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-200 active:scale-95 transition-all">
                <i data-lucide="check" class="w-6 h-6"></i>
                プレビュー作成
            </button>
        </div>

        <div id="bar-preview" class="fixed-action-bar hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-1.5">
                    <button id="btn-copy" class="flex items-center justify-center gap-2 py-4 bg-slate-100 text-slate-800 rounded-2xl font-bold active:scale-95 transition-all">
                        <i data-lucide="copy" class="w-5 h-5"></i>
                        コピー (PNG)
                    </button>
                    <p class="text-[9px] text-center text-slate-400 font-medium leading-tight">高互換・保存も実行</p>
                </div>
                <div class="flex flex-col gap-1.5">
                    <button id="btn-share" class="flex items-center justify-center gap-2 py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all">
                        <i data-lucide="share-2" class="w-5 h-5"></i>
                        保存・共有 (JPEG)
                    </button>
                    <p class="text-[9px] text-center text-indigo-500 font-medium leading-tight">高画質・軽量保存</p>
                </div>
            </div>
            <button id="btn-back-to-edit" class="w-full flex items-center justify-center gap-2 py-2 text-slate-400 font-semibold active:text-slate-800 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                編集に戻る
            </button>
        </div>

        <canvas id="hidden-canvas" class="hidden"></canvas>
    </div>

    <script type="module">
        const state = {
            stage: 'SELECT',
            imageSrc: null,
            processedImageSrc: null,
            timestamp: '',
            history: [],
            historyIndex: -1
        };

        const dom = {
            stages: {
                SELECT: document.getElementById('stage-select'),
                EDIT: document.getElementById('stage-edit'),
                PREVIEW: document.getElementById('stage-preview')
            },
            bars: {
                EDIT: document.getElementById('bar-edit'),
                PREVIEW: document.getElementById('bar-preview')
            },
            btnGlobalBack: document.getElementById('btn-global-back'),
            btnReset: document.getElementById('btn-reset'),
            cameraInput: document.getElementById('camera-input'),
            fileInput: document.getElementById('file-input'),
            btnCamera: document.getElementById('btn-camera'),
            btnFile: document.getElementById('btn-file'),
            imgEditPreview: document.getElementById('img-edit-preview'),
            txtComment: document.getElementById('txt-comment'),
            btnUndo: document.getElementById('btn-undo'),
            btnRedo: document.getElementById('btn-redo'),
            btnDelete: document.getElementById('btn-delete'),
            btnGeneratePreview: document.getElementById('btn-generate-preview'),
            imgFinalResult: document.getElementById('img-final-result'),
            infoFileSize: document.getElementById('info-file-size'),
            infoPngEstimate: document.getElementById('info-png-estimate'),
            btnCopy: document.getElementById('btn-copy'),
            btnShare: document.getElementById('btn-share'),
            btnBackToEdit: document.getElementById('btn-back-to-edit'),
            canvas: document.getElementById('hidden-canvas'),
            mainContent: document.getElementById('main-content')
        };

        function pushToHistory() {
            const currentVal = dom.txtComment.value;
            if (state.historyIndex >= 0 && state.history[state.historyIndex] === currentVal) return;
            state.history = state.history.slice(0, state.historyIndex + 1);
            state.history.push(currentVal);
            state.historyIndex = state.history.length - 1;
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            dom.btnUndo.disabled = state.historyIndex <= 0;
            dom.btnRedo.disabled = state.historyIndex >= state.history.length - 1;
        }

        function updateUI() {
            Object.keys(dom.stages).forEach(key => dom.stages[key].classList.toggle('hidden', key !== state.stage));
            dom.bars.EDIT.classList.toggle('hidden', state.stage !== 'EDIT');
            dom.bars.PREVIEW.classList.toggle('hidden', state.stage !== 'PREVIEW');
            dom.btnGlobalBack.classList.toggle('hidden', state.stage === 'SELECT');
            dom.btnReset.classList.toggle('hidden', state.stage !== 'PREVIEW');

            if (state.stage === 'EDIT') {
                dom.imgEditPreview.src = state.imageSrc;
                dom.mainContent.scrollTop = 0;
            }
            if (state.stage === 'PREVIEW') {
                dom.imgFinalResult.src = state.processedImageSrc;
                dom.mainContent.scrollTop = 0;
            }
            lucide.createIcons();
            updateHistoryButtons();
        }

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                state.imageSrc = e.target.result;
                state.timestamp = new Date().toLocaleString('ja-JP');
                dom.txtComment.value = `${state.timestamp}\n`;
                state.history = [];
                state.historyIndex = -1;
                pushToHistory();
                state.stage = 'EDIT';
                updateUI();
            };
            reader.readAsDataURL(file);
        }

        async function generateCard() {
            const ctx = dom.canvas.getContext('2d', { alpha: false }); 
            const img = new Image();
            img.src = state.imageSrc;
            await new Promise(res => img.onload = res);
            
            // 最適解像度: 3072から2560へ微調整
            const MAX_WIDTH = 2560;
            let canvasWidth = img.naturalWidth;
            let canvasHeightRaw = img.naturalHeight;
            
            if (canvasWidth > MAX_WIDTH) {
                const ratio = MAX_WIDTH / canvasWidth;
                canvasWidth = MAX_WIDTH;
                canvasHeightRaw = canvasHeightRaw * ratio;
            }

            const comment = dom.txtComment.value.trim();
            
            if (!comment) {
                dom.canvas.width = canvasWidth;
                dom.canvas.height = canvasHeightRaw;
                ctx.drawImage(img, 0, 0, canvasWidth, canvasHeightRaw);
            } else {
                const lines = dom.txtComment.value.split('\n');
                const fontSize = Math.max(24, Math.round(canvasWidth * 0.035)); 
                const lineHeight = Math.round(fontSize * 1.5);
                const paddingVertical = Math.round(fontSize * 2);
                
                const footerHeight = paddingVertical + (lines.length * lineHeight) + paddingVertical;
                dom.canvas.width = canvasWidth;
                dom.canvas.height = canvasHeightRaw + footerHeight;
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, dom.canvas.width, dom.canvas.height);
                ctx.drawImage(img, 0, 0, canvasWidth, canvasHeightRaw);
                
                ctx.fillStyle = '#1e293b';
                ctx.font = `bold ${fontSize}px "Inter", "Noto Sans JP", sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                
                let y = canvasHeightRaw + paddingVertical;
                lines.forEach(l => {
                    ctx.fillText(l, canvasWidth / 2, y);
                    y += lineHeight;
                });
            }
            
            // 圧縮率調整: 0.92から0.90へ微調整
            state.processedImageSrc = dom.canvas.toDataURL('image/jpeg', 0.90);
            
            const head = 'data:image/jpeg;base64,';
            const sizeInBytes = Math.round((state.processedImageSrc.length - head.length) * 3 / 4);
            const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
            const pngEstimate = (parseFloat(sizeInMB) * 10).toFixed(1);
            
            dom.infoFileSize.innerHTML = `
                <span class="px-1.5 py-0.5 bg-indigo-600 text-white rounded text-[10px]">JPEG</span>
                約 ${sizeInMB} MB (高画質)
            `;
            dom.infoPngEstimate.textContent = `※PNG形式の場合、約 ${pngEstimate} MB になります`;
            
            state.stage = 'PREVIEW';
            updateUI();
        }

        function downloadDataUrl(dataUrl, filename) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        dom.btnCamera.onclick = () => dom.cameraInput.click();
        dom.btnFile.onclick = () => dom.fileInput.click();
        dom.cameraInput.onchange = (e) => handleFile(e.target.files[0]);
        dom.fileInput.onchange = (e) => handleFile(e.target.files[0]);
        dom.btnGeneratePreview.onclick = generateCard;
        dom.btnGlobalBack.onclick = () => { state.stage = 'SELECT'; updateUI(); };
        dom.btnBackToEdit.onclick = () => { state.stage = 'EDIT'; updateUI(); };
        dom.btnReset.onclick = () => { state.stage = 'SELECT'; updateUI(); };
        
        dom.btnCopy.onclick = async () => {
            try {
                const img = new Image();
                img.src = state.processedImageSrc;
                await new Promise(res => img.onload = res);
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                const tCtx = tempCanvas.getContext('2d');
                tCtx.drawImage(img, 0, 0);
                
                tempCanvas.toBlob(async (blob) => {
                    if (!blob) throw new Error("Blob creation failed");
                    
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                    } catch (err) {
                        console.warn("Clipboard failed", err);
                    }

                    const reader = new FileReader();
                    reader.onload = () => {
                        downloadDataUrl(reader.result, `moments-copy-${Date.now()}.png`);
                        alert("クリップボードにコピーし、ローカルにもPNGとして保存しました");
                    };
                    reader.readAsDataURL(blob);
                }, 'image/png');
            } catch (e) { alert("コピーに失敗しました"); }
        };

        dom.btnShare.onclick = async () => {
            try {
                downloadDataUrl(state.processedImageSrc, `moments-${Date.now()}.jpg`);
                const response = await fetch(state.processedImageSrc);
                const blob = await response.blob();
                const file = new File([blob], `photo-${Date.now()}.jpg`, { type: 'image/jpeg' });
                
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: 'Photo Moments' });
                } else {
                    alert("JPEG形式でローカルに保存しました");
                }
            } catch (e) { alert("保存に失敗しました"); }
        };

        dom.btnUndo.onclick = () => {
            if(state.historyIndex > 0) {
                state.historyIndex--;
                dom.txtComment.value = state.history[state.historyIndex];
                updateHistoryButtons();
            }
        };
        dom.btnRedo.onclick = () => {
            if(state.historyIndex < state.history.length - 1) {
                state.historyIndex++;
                dom.txtComment.value = state.history[state.historyIndex];
                updateHistoryButtons();
            }
        };
        dom.btnDelete.onclick = () => { dom.txtComment.value = ""; pushToHistory(); };
        let t;
        dom.txtComment.oninput = () => {
            clearTimeout(t);
            t = setTimeout(pushToHistory, 400); 
        };

        updateUI();
    </script>
</body>
</html>
